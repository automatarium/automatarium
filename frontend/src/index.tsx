import { StrictMode, createElement, useEffect } from 'react'
import ReactDOM from 'react-dom'
import { setup } from 'goober'
import { BrowserRouter, Route, Routes, useLocation } from 'react-router-dom'

import * as Pages from './pages'

import { useEgg } from '/src/hooks'
import { usePreferencesStore, useProjectStore } from '/src/stores'
import COLORS from '/src/config/colors'
import { Footer } from '/src/components'
import { Warning } from '/src/components/Warning/Warning'

import favicon from 'bundle-text:/public/logo.svg'

// Set up goober to use React
setup(
  createElement,
  undefined, undefined,
  // Remove transient props from the DOM
  props => Object.keys(props).forEach(p => p[0] === '$' && delete props[p])
)

const App = () => {
  const location = useLocation()
  const hideFooter = location.pathname.match('/editor')

  // Set color theme
  const colorPref = usePreferencesStore(state => state.preferences.color)
  const projectColor = useProjectStore(state => state.project?.config.color)
  useEffect(() => {
    const computedColor = (projectColor !== '' && projectColor) || 'orange'
    const color = colorPref === 'match' ? COLORS[computedColor] : COLORS[colorPref]
    document.documentElement.style.setProperty('--primary-h', color.h.toString())
    document.documentElement.style.setProperty('--primary-s', color.s + '%')
    document.documentElement.style.setProperty('--primary-l', color.l + '%')

    // Set favicon
    const link = document.querySelector('head link[rel=icon]')
    link.setAttribute(
      'href',
      'data:image/svg+xml,' +
      encodeURIComponent(favicon
        .replace(/var\(--primary, (.*?)\)/, `hsl(${color.h} ${color.s}% ${color.l}%)`)
        .replace(/var\(--state-bg, (.*?)\)/, `hsl(${color.h} ${color.s}% 75%)`)
      )
    )
  }, [colorPref, projectColor])

  // Set light/dark mode
  const themePref = usePreferencesStore(state => state.preferences.theme)
  useEffect(() => {
    document.body.classList.toggle('light', themePref === 'light')
    document.body.classList.toggle('dark', themePref === 'dark')
  }, [themePref])

  // Check if the pauseTM preference is missing
  const preferences = usePreferencesStore(state => state.preferences)
  const setPreferences = usePreferencesStore(state => state.setPreferences)
  if (typeof preferences.pauseTM === 'undefined') {
    // Add the pauseTM preference with a default value
    setPreferences({ ...preferences, pauseTM: true })
  }

  useEgg()

  return <>
    <Routes>
      <Route path="/" element={<Pages.Landing />} />
      <Route path="/editor" element={<Pages.Editor />} />
      <Route path="/about" element={<Pages.About />} />
      <Route path="/privacy" element={<Pages.Privacy />} />
      <Route path="/new" element={<Pages.NewFile />} />
      <Route path="/share/:type/:data" element={<Pages.Share />} />
      <Route path="/tutorials" element={<Pages.TutorialsPage />} />
      <Route path="/example" element={<Pages.Example/>} />
      <Route path="*" element={<Pages.NotFound />} />
    </Routes>
    {!hideFooter && <Footer />}
    <Warning />
    <Pages.Preferences />
  </>
}

// Render the app
ReactDOM.render(
  <StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </StrictMode>,
  document.getElementById('app')
)
